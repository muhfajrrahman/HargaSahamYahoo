<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Harga Saham Yahoo</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input[type="text"] {
      width: 1220px; padding: 8px; font-size: 16px;
    }
    button {
      padding: 8px 12px; font-size: 16px; margin-left: 10px;
    }
    #status {
      background: #f3faff;
      border: 1px solid #99ccff;
      padding: 10px;
      color: #0066cc;
      margin-top: 10px;
      font-weight: bold;
    }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2>üìà Data OHLCV Saham dari Yahoo Finance</h2>
  <div>
    <input type="text" id="input-kode" placeholder="Contoh: BBCA, BBRI, GOOD, ANTM">
    <button id="btn-fetch">Ambil Data</button>
  </div>

  <div id="status"></div>
  <div id="result"></div>

  <script>
    document.getElementById("btn-fetch").addEventListener("click", async () => {
      const input = document.getElementById("input-kode").value;
      if (!input) return alert("Masukkan minimal 1 kode saham.");

      const list = input.split(",").map(s => s.trim().toUpperCase()).filter(Boolean);
      const results = [];
      let counter = 0;

      const statusDiv = document.getElementById("status");
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";
      statusDiv.innerText = "‚è≥ Memuat data saham...";

      for (let kode of list) {
        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));

        try {
          const url = `https://api.cors.lol/?url=https://query1.finance.yahoo.com/v8/finance/chart/${kode}.JK?interval=1d&range=1d`;
          const res = await fetch(url);
          const json = await res.json();
          const d = json.chart.result[0];
          const q = d.indicators.quote[0];
          const ts = d.timestamp[0];

          const waktu = new Date(ts * 1000);
          const tanggal = waktu.toLocaleDateString("id-ID", { day: "2-digit", month: "2-digit" });
          const jam = waktu.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit", hour12: false });

          const open = q.open[0];
          const close = q.close[0];
          const high = q.high[0];
          const low = q.low[0];
          const volume = (q.volume[0] / 100).toFixed(0);

          results.push({
            kode,
            date: `${tanggal}-${jam}`,
            close,
            open,
            change: (close - open).toFixed(2),
            high,
            low,
            delta: (high - low).toFixed(2),
            volume
          });

          counter++;
          statusDiv.innerText = `‚úÖ ${counter} data berhasil diambil...`;

        } catch {
          results.push({ kode, error: true });
        }
      }

      statusDiv.innerText = `‚úÖ Proses selesai (${counter} data berhasil).`;

      // Buat tabel hasil
      const tableHTML = `
        <table id="ohlcv-table">
          <thead>
            <tr>
              <th>Kode</th><th>Waktu</th><th>Close</th><th>Open</th><th>+/-</th>
              <th>High</th><th>Low</th><th>Delta</th><th>Volume (lot)</th>
            </tr>
          </thead>
          <tbody>
            ${results.map(r => r.error
              ? `<tr><td colspan="9" style="color:red;">${r.kode}: gagal fetch</td></tr>`
              : `<tr>
                  <td>${r.kode}</td><td>${r.date}</td><td>${r.close}</td><td>${r.open}</td>
                  <td>${r.change}</td><td>${r.high}</td><td>${r.low}</td><td>${r.delta}</td><td>${r.volume}</td>
                </tr>`
            ).join("")}
          </tbody>
        </table>
        <p><em>‚úÖ Data otomatis disalin ke clipboard</em></p>
      `;
      resultDiv.innerHTML = tableHTML;

      // Copy ke clipboard
      const rows = document.querySelectorAll("#ohlcv-table tr");
      let text = "";
      rows.forEach(row => {
        const cols = row.querySelectorAll("th, td");
        const rowText = Array.from(cols).map(col => col.innerText).join("\t");
        text += rowText + "\n";
      });

      try {
        await navigator.clipboard.writeText(text);
        alert("‚úÖ Data berhasil disalin ke clipboard!");
      } catch (e) {
        alert("‚ùå Gagal salin ke clipboard: " + e.message);
      }
    });
  </script>
</body>
</html>
